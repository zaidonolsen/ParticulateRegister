using ParticulateRegister.Domain.Interfaces;
using ParticulateRegister.Domain.Models;
using AutoMapper;

namespace ParticulateRegister.Domain.Services
{
    public class ParticulateService : IParticulateService
    {
        private readonly IParticulateRepository _repository;
        private readonly IMapper _mapper;

        public ParticulateService(IParticulateRepository repository, IMapper mapper)
        {
            _repository = repository;
            _mapper = mapper;
        }

        public Task<IEnumerable<ParticulateDto>> GetAllAsync() => _repository.GetAllAsync();
        public Task<ParticulateDto?> GetByIdAsync(Guid id) => _repository.GetByIdAsync(id);
        public Task AddAsync(ParticulateDto particulate) => _repository.AddAsync(particulate);
        public Task UpdateAsync(ParticulateDto particulate) => _repository.UpdateAsync(particulate);

        public async Task AddAsync(ParticulateCreateDto dto)
        {
            var particulate = _mapper.Map<ParticulateDto>(dto);
            particulate.Id = Guid.NewGuid();
            particulate.History = new List<ParticulateHistoryDto>
            {
                new ParticulateHistoryDto
                {
                    Id = Guid.NewGuid(),
                    ParticulateId = particulate.Id,
                    Date = DateTimeOffset.UtcNow,
                    Status = dto.DetectionStatus,
                    Notes = dto.DetectionNotes
                }
            };
            await _repository.AddAsync(particulate);
        }

        public async Task UpdateAsync(ParticulateUpdateDto dto)
        {
            var existing = await _repository.GetByIdAsync(dto.Id);
            if (existing == null) return;
            bool statusChanged = existing.DetectionStatus != dto.DetectionStatus || existing.DetectionNotes != dto.DetectionNotes;
            _mapper.Map(dto, existing);
            if (statusChanged)
            {
                existing.History.Add(new ParticulateHistoryDto
                {
                    Id = Guid.NewGuid(),
                    ParticulateId = existing.Id,
                    Date = DateTimeOffset.UtcNow,
                    Status = dto.DetectionStatus,
                    Notes = dto.DetectionNotes
                });
            }
            await _repository.UpdateAsync(existing);
        }

        public Task DeleteAsync(Guid id) => _repository.DeleteAsync(id);
    }
}
